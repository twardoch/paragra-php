---
this_file: paragra-php/docs/configuration.md
---

# ParaGra Configuration Guide

Working within `paragra-php`, this guide explains how to populate `config/paragra.php` so ParaGra can rotate keys and fail over across multiple Retrieval-Augmented Generation (RAG) providers.

## 1. Copy the template

```bash
cd paragra-php
cp config/paragra.example.php config/paragra.php
```

Keep the new file out of git and load secrets via `getenv()` or your secrets manager. ParaGra expects `return [...]` at the end of the file.

## 2. Understand the schema

`ParaGra::fromConfig()` receives an array with a `priority_pools` key and, optionally, a pointer to the provider catalog generated by `tools/sync_provider_catalog.php`:

```php
return [
    'provider_catalog' => __DIR__ . '/providers/catalog.php', // optional but recommended
    'priority_pools' => [
        // Pool definitions...
    ],
];
```

### Manual provider specs

Legacy (and still supported) configs can inline the `provider`, `model`, `api_key`, and `solution` keys:

```php
return [
    'priority_pools' => [
        // Pool #1 (free tier keys)
        [
            [
                'provider' => 'cerebras',
                'model' => 'llama-3.3-70b',
                'api_key' => getenv('CEREBRAS_API_KEY_1'),
                'solution' => [
                    'type' => 'ragie',
                    'ragie_api_key' => getenv('RAGIE_API_KEY'),
                ],
            ],
            // add more keys to the same pool for rotation
        ],
        // Pool #2 (paid fallback) ...
    ],
];
```

- **Pools** are ordered lists. Pool `0` is tried first, pool `1` only runs when all providers in pool `0` fail.
- **Providers inside a pool** form a rotation set. `KeyRotator` walks them in a deterministic order (timestamp+index) to keep usage even.
- `provider`, `model`, and `api_key` describe the target LLM host. `solution` configures the retrieval strategy.

### Catalog-backed provider entries

You can now reference any slug from `config/providers/catalog.php` (OpenAI, Cerebras, Gemini, AskYoda, etc.) instead of repeating boilerplate:

```php
return [
    'provider_catalog' => __DIR__ . '/providers/catalog.php',
    'priority_pools' => [
        [
            [
                'catalog' => [
                    'slug' => 'cerebras',
                    'model_type' => 'generation', // optional, defaults to `generation`
                    'overrides' => [
                        'api_key' => (string) getenv('CEREBRAS_API_KEY_1'), // rotate multiple keys
                        'solution' => [
                            'ragie_api_key' => (string) getenv('RAGIE_API_KEY'),
                        ],
                    ],
                ],
                'latency_tier' => 'low',
                'cost_ceiling' => 0.00,
                'compliance' => ['internal'],
                'metadata_overrides' => ['notes' => 'Preferred free tier slot'],
            ],
        ],
    ],
];
```

`catalog` may also be declared with helper keys:

| Key | Purpose |
| --- | --- |
| `catalog_slug` | Shortcut for `['catalog' => ['slug' => 'openai']]`. |
| `catalog_model_type` | Override the model preset to pull from catalog metadata (`generation`, `embedding`, `fast_generation`, etc.). |
| `catalog_overrides` | Same as `catalog.overrides` but top-level for readability. |

Every catalog-backed entry inherits metadata from the catalog (tier, provider name, capability hints). Use these overrides to tailor responses:

| Key | Effect |
| --- | --- |
| `latency_tier` | Adds/overrides `solution.metadata.latency_tier`. |
| `cost_ceiling` | Adds `solution.metadata.cost_ceiling` so dashboards know when to escalate. |
| `compliance` | Array/string describing regulatory requirements satisfied by the pool. |
| `metadata_overrides` | Free-form metadata merged into the catalog metadata block. |

ParaGra resolves the provider API key using catalog metadata unless you supply `overrides.api_key`. That pattern lets you rotate multiple Cerebras or Ragie keys even when the shared slug points at a single env var.

### Auto-generated pools via PoolBuilder

Maintaining nested arrays is tedious, so a `ParaGra\Planner\PoolBuilder` now ships with presets:

```php
use ParaGra\Planner\PoolBuilder;
use ParaGra\ProviderCatalog\ProviderDiscovery;

$catalogPath = __DIR__ . '/providers/catalog.php';
$catalog = ProviderDiscovery::fromFile($catalogPath);
$builder = PoolBuilder::fromGlobals($catalog);

$options = [
    'ragie_partition' => getenv('RAGIE_PARTITION') ?: 'default',
    'ragie_defaults' => ['top_k' => 8],
];

$config = [
    'provider_catalog' => $catalogPath,
    'priority_pools' => $builder->build(PoolBuilder::PRESET_FREE, $options),
];
```

Available presets:

| Preset | Description | Required env |
| --- | --- | --- |
| `free-tier` | Gemini Flash + Groq rotation with optional Cerebras keys, all backed by Ragie. | `RAGIE_API_KEY`, `GOOGLE_API_KEY`, `GROQ_API_KEY` |
| `hybrid` | Free rotation plus OpenAI/Pinecone fallback. | `RAGIE_API_KEY`, `GOOGLE_API_KEY`, `GROQ_API_KEY`, `OPENAI_API_KEY` |
| `hosted` | AskYoda hosted fallback annotated with Vectara + Bedrock KB insights. | `EDENAI_API_KEY`, `EDENAI_ASKYODA_PROJECT` |

`PoolBuilder` automatically surfaces catalog metadata (free-tier quotas, recommended roles) and throws descriptive exceptions when something is missing, making it a natural fit for configs that live inside `ask.vexy.art` or other apps. The matching CLI (`php tools/pool_builder.php --preset=hybrid --format=json`) emits JSON/PHP payloads when you need to commit a generated config to disk.

## 3. Provider-specific solution keys

| Solution type | Required keys | Optional keys |
| --- | --- | --- |
| `ragie` | `ragie_api_key` | `ragie_base_url`, `ragie_partition`, `default_options.top_k`, `default_options.filter`, `default_options.rerank`, `metadata` |
| `gemini-file-search` | `vector_store.corpus` (from Google AI Platform), `api_key` (defaults to provider `api_key`) | `generation.temperature`, `generation.maxOutputTokens`, `safety.safetySettings`, `metadata` |
| `askyoda` | `askyoda_api_key`, `project_id` | `default_options.k`, `default_options.min_score`, `default_options.temperature`, `default_options.max_tokens`, `llm.provider`, `llm.model`, `metadata` |

Each provider inherits `solution.metadata` so ParaGra can emit tier info (`free`, `paid`, etc.) in responses.

## 4. Environment variables to define

| Env var | Purpose |
| --- | --- |
| `RAGIE_API_KEY`, `RAGIE_PARTITION` | Authenticates Ragie retrieval for all Ragie-backed pools. |
| `CEREBRAS_API_KEY_*` | Publish multiple Cerebras keys (e.g., `_1`, `_2`, `_3`) so pool #1 can rotate across free-tier capacity. |
| `OPENAI_API_KEY` | Paid fallback for Ragie + OpenAI completions. |
| `GOOGLE_API_KEY`, `GEMINI_DATASTORE_ID` (preferred) or `GEMINI_CORPUS_ID`/`GEMINI_VECTOR_STORE` | Access Gemini File Search retrieval + generation. |
| `GEMINI_EMBED_API_KEY`, `GEMINI_EMBED_MODEL`, `GEMINI_EMBED_DIMENSIONS`, `GEMINI_EMBED_MAX_BATCH`, `GEMINI_EMBED_TASK_TYPE`, `GEMINI_EMBED_TITLE` | Optional Gemini embedding provider controls. ParaGra falls back to `GOOGLE_API_KEY` when `GEMINI_EMBED_API_KEY` is unset; overrides are only respected for models that support custom dimensions (`text-embedding-004`). |
| `EDENAI_API_KEY`, `EDENAI_ASKYODA_PROJECT` | Drive AskYoda retrieval fallback. |
| `OPENAI_MODERATION_TRUE` | Set to `1` when hooking `withModeration(OpenAiModerator::fromEnv())`. |

Follow the naming already used inside `ask.vexy.art/private/.env.example` to keep local development and production in sync.

When enriching empty contexts with the `twat-search` fallback, add:

| Env var | Purpose |
| --- | --- |
| `TWAT_SEARCH_BIN` | Path to the `twat-search` binary (defaults to `twat-search`). |
| `TWAT_SEARCH_ENGINES` | Comma-separated engine identifiers (e.g., `brave,duckduckgo,tavily`). |
| `TWAT_SEARCH_NUM_RESULTS`, `TWAT_SEARCH_MAX_RESULTS` | Default per-engine and combined snippet counts used by `TwatSearchRetriever`. |
| `TWAT_SEARCH_CACHE_TTL` | Seconds to keep CLI responses in memory (guards repeated debug calls). |
| `TAVILY_API_KEY`, `BRAVE_API_KEY`, `YOU_API_KEY`, `SERPAPI_API_KEY` | Optional API keys enabling the matching engines inside `twat-search`. |

When enabling optional media providers, add:

| Env var | Purpose |
| --- | --- |
| `CHUTES_API_KEY` | Required Bearer token for your chute. |
| `CHUTES_BASE_URL` | Base URL (e.g., `https://artist-demo.chutes.ai`). |
| `CHUTES_MODEL`, `CHUTES_GUIDANCE`, `CHUTES_STEPS`, `CHUTES_ASPECT_RATIO`, `CHUTES_IMAGES` | Optional overrides passed to `ChutesImageProvider`. |
| `FAL_KEY` | Fal.ai API key. |
| `FAL_MODEL` | Fal model endpoint (e.g., `fal-ai/flux/dev`). |
| `FAL_IMAGES`, `FAL_GUIDANCE`, `FAL_STEPS` | Optional overrides passed to `FalImageProvider`. |

## 5. Validate the configuration

1. Run ParaGra's QA suite:
   ```bash
   cd paragra-php
   composer qa
   ```
2. When wiring ParaGra into `ask.vexy.art`, execute the smoke test:
   ```bash
   php ask.vexy.art/tests/paragra_config_test.php
   ```
3. Keep `config/paragra.php` under 200 lines by extracting repeated provider specs to helper functions if necessary.

ParaGra throws `InvalidArgumentException` when `priority_pools` is missing or malformed, and `ConfigurationException` if a provider spec lacks the required keys. Fix these errors before deploying.

## 6. Secrets hygiene checklist

- Store `.env` under `ask.vexy.art/private/` and load values via `getenv()` inside `config/paragra.php`.
- Avoid dumping API keys inside logs; ParaGra metadata intentionally excludes raw keys.
- If you depend on multiple Ragie partitions, pass `['partition' => 'support']` inside the `default_options` for that provider.

With this structure in place, ParaGra can execute retrieval + answer flows purely from configuration without manual branching in your endpoints.
